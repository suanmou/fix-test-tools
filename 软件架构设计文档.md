# QuickFIX/J 回归测试工具 - 软件架构设计文档

## 1. 架构概览

### 1.1 设计目标

构建一个 模块化、可扩展、高可靠 的 QuickFIX/J 回归测试平台，支持全面的 FIX 协议场景验证和自动化回归测试。

### 1.2 核心架构原则

- 模块化设计 ：松耦合、高内聚的组件结构
- 可扩展性 ：支持新的测试场景和协议版本
- 可维护性 ：清晰的代码结构和完善的文档
- 高性能 ：支持并发执行和高效资源利用
- 可观测性 ：完整的日志、监控和报告机制

## 2. 系统架构图

```
┌───────────────────────────────────
──────────────────────────┐
│                    测试执行层 
(Test Execution 
Layer)               │
├───────────────────────────────────
──────────────────────────┤
│  CLI接口    │    CI/CD集成    │    
并发引擎    │    调度器    │
│  (Command   │   (Jenkins/    │   
(Parallel   │   (Scheduler) │
│   Line)     │    GitLab)     │    
Engine)    │              │
└───────────────────────────────────
──────────────────────────┘
                              │
┌───────────────────────────────────
──────────────────────────┐
│                    核心服务层 
(Core Service Layer)               │
├───────────────────────────────────
──────────────────────────┤
│ 场景管理    │    测试引擎     │    
验证器      │    报告器    │
│ (Scenario  │   (Test        │  
(Validator)   │  (Reporter)  │
│  Manager)   │   Engine)      
│                │              │
└───────────────────────────────────
──────────────────────────┘
                              │
┌───────────────────────────────────
──────────────────────────┐
│                    模拟器层 
(Simulator 
Layer)                    │
├───────────────────────────────────
──────────────────────────┤
│  Acceptor   │    Initiator   │    
消息工厂    │    状态机    │
│ Simulator   │   Simulator    │  
(Message     │  (State      │
│             │                │   
Factory)     │   Machine)   │
└───────────────────────────────────
──────────────────────────┘
                              │
┌───────────────────────────────────
──────────────────────────┐
│                    基础设施层 
(Infrastructure 
Layer)               │
├───────────────────────────────────
──────────────────────────┤
│ 配置管理    │    日志系统     │    
监控指标    │    模板引擎  │
│ (Config)    │   (Logging)    │  
(Metrics)     │  (Template)  │
│             │                
│                │              │
└───────────────────────────────────
──────────────────────────┘
```

## 3. 核心组件设计

### 3.1 测试场景管理 (Test Scenario Manager)

#### 3.1.1 数据结构

```
# 测试场景配置示例
scenario:
  id: "SCN_001"
  name: "正常登录场景"
  description: "验证正常登录流程"
  jira: "PROJ-123"
  
  configuration:
    quickfix_config: "config/
    initiator.cfg"
    initial_seq_num: 1
    login_state: "DISCONNECTED"
    
  sequence:
    - action: "WAIT_LOGIN"
      timeout: 30s
      expected:
        session_state: "LOGGED_IN"
        message_type: "LOGON"
        
    - action: "SEND_HEARTBEAT"
      message_template: 
      "heartbeat_template.xml"
      expected:
        response_type: "HEARTBEAT"
        within: 5s
```

#### 3.1.2 核心类设计

```
//  场景定义模型

public class TestScenario {
    private String id;
    private String name;
    private String description;
    private Map<String, Object> 
    metadata;
    private Configuration 
    configuration;
    private List<TestStep> sequence;
    private List<Assertion> 
    assertions;
}

//  测试步骤定义
public class TestStep {
    private String action;
    private Map<String, Object> 
    parameters;
    private Duration timeout;
    private ExpectedResult expected;
}

```

### 3.2 FIX 协议模拟器 (FIX Simulator)

#### 3.2.1 架构模式

采用 策略模式(Strategy Pattern) **状态模式(State Pattern)** 实现可配置的模拟器行为

#### 3.2.2 核心接口

```

//  模拟器接口
public interface FIXSimulator {
    void start() throws ConfigError;
    void stop();
    void sendMessage(Message 
    message) throws SessionNotFound;
    void setBehavior
    (BehaviorConfiguration config);
}

//  行为配置接口
public interface 
BehaviorConfiguration {
    ResponseAction determineResponse
    (Message receivedMessage);
    boolean shouldInitiateAction();
    Message createInitiationMessage
    ();
}

```

#### 3.2.3 双模式实现

- AcceptorSimulator : 监听端口，接收连接请求
- InitiatorSimulator : 主动连接，发送初始消息

### 3.3 消息验证器 (Message Validator)

#### 3.3.1 验证层级

1. 语法验证 : 消息格式、字段存在性
2. 语义验证 : 字段值范围、业务规则
3. 时序验证 : 消息顺序、超时处理
4. 状态验证 : 会话状态、业务状态

#### 3.3.2 验证器链模式

```

public class ValidationChain {
    private List<MessageValidator> 
    validators;

public ValidationResult validate
    (Message message, 
    ValidationContext context) {
        for (MessageValidator 
        validator : validators) {
            ValidationResult result 
            = validator.validate
            (message, context);
            if (!result.isValid()) {
                return result;
            }
        }
        return ValidationResult.
        success();
    }
}

```

### 3.4 测试引擎 (Test Engine)

#### 3.4.1 执行流程

```

1.  加载场景配置
2.  初始化模拟器
3.  执行测试序列
4.  实时监控验证
5.  收集执行结果
6.  生成测试报告

```

#### 3.4.2 并发控制

```

public class ParallelTestExecutor {
    private ExecutorService 
    executorService;
    private 
    CompletionService<TestResult> 
    completionService;

public List<TestResult> 
    executeScenarios
    (List<TestScenario> scenarios) {
        //  使用 ForkJoinPool 实现高效的
         并发执行
        return scenarios.
        parallelStream()
            .map
            (this::executeSingleScen
            ario)
            .collect(Collectors.
            toList());
    }
}

```

## 4. 数据模型设计

### 4.1 消息模板系统

```

//  消息模板定义
public class MessageTemplate {
    private String templateId;
    private String messageType;
    private Map<String, 
    TemplateField> fields;
    private List<ValidationRule> 
    rules;
}

//  字段模板
public class TemplateField {
    private String tag;
    private String value;
    private FieldType type;
    private boolean required;
    private List<ValidationRule> 
    validations;
}

```

### 4.2 会话状态模型

```

public enum SessionState {
    DISCONNECTED,
    CONNECTING,
    LOGON_SENT,
    LOGON_RECEIVED,
    LOGGED_IN,
    LOGOUT_SENT,
    LOGOUT_RECEIVED,
    RECONNECTING
}

public class SessionContext {
    private SessionID sessionId;
    private SessionState 
    currentState;
    private int nextSenderSeqNum;
    private int nextTargetSeqNum;
    private Map<String, Object> 
    sessionData;
}

```

## 5. 技术栈选择

### 5.1 核心框架

| 组件类型 | 技术选型   | 版本    | 选择理由                 |
| -------- | ---------- | ------- | ------------------------ |
| FIX 引擎 | QuickFIX/J | 2.3.1   | 行业标准，稳定可靠       |
| 测试框架 | JUnit      | 5 5.9.x | 现代测试框架，支持并发   |
| 断言库   | AssertJ    | 3.24.x  | 流式 API，易于使用       |
| 配置解析 | Jackson    | 2.15.x  | JSON/YAML 解析，性能优秀 |
| 模板引擎 | Freemarker | 2.3.x   | 强大的模板处理能力       |

### 5.2 基础设施

- 日志系统 : SLF4J + Logback
- 监控指标 : Micrometer + Prometheus
- 报告生成 : Allure Framework
- 构建工具 : Maven
- CI/CD : Jenkins/GitLab CI

## 6. 模块划分与包结构

```

com.quickfix.testtool/
├── core/
│   ├── engine/           #  测试引擎
│   ├── scenario/         #  场景管理
│   └── validation/       #  验证逻辑
├── simulator/
│   ├── acceptor/         # Acceptor
模拟器
│   ├── initiator/        # 
Initiator 模拟器
│   └── behavior/         #  行为配置
├── message/
│   ├── template/         #  消息模板
│   ├── factory/          #  消息工厂
│   └── validation/       #  消息验证
├── config/
│   ├── parser/           #  配置解析
│   └── validator/        #  配置验证
├── report/
│   ├── generator/        #  报告生成
│   └── exporter/         #  报告导出
└── infrastructure/
    ├── logging/          #  日志配置
    ├── metrics/           #  监控指标
    └── persistence/       #  数据持久
     化

```

## 7. 关键设计模式

### 7.1 创建型模式

- 工厂模式 : MessageFactory 创建不同类型的 FIX 消息
- 建造者模式 : 构建复杂的测试场景配置
- 单例模式 : 全局配置管理器

### 7.2 行为型模式

- 策略模式 : 不同的验证策略
- 状态模式 : 会话状态管理
- 观察者模式 : 测试事件监听

### 7.3 结构型模式

- 适配器模式 : 统一不同版本 FIX 协议
- 装饰器模式 : 动态添加验证规则
- 组合模式 : 组织复杂的测试场景

## 8. 异常处理策略

### 8.1 异常分类

1. 配置异常 : 场景配置错误、模板错误
2. 网络异常 : 连接失败、超时、断开
3. 协议异常 : 消息格式错误、序列号问题
4. 业务异常 : 验证失败、状态错误

### 8.2 处理机制

```

public class TestExceptionHandler {
    public void handleException
    (TestExecutionContext context, 
    Exception exception) {
        //  分类处理异常
        TestExceptionType type = 
        classifyException
        (exception);

switch (type) {
            case CONFIG_ERROR:
                handleConfigError
                (context, 
                exception);
                break;
            case NETWORK_ERROR:
                handleNetworkError
                (context, 
                exception);
                break;
            case PROTOCOL_ERROR:
                handleProtocolError
                (context, 
                exception);
                break;
            default:
                handleUnexpectedErro
                r(context, 
                exception);
        }
    }
}

```

## 9. 性能优化策略

### 9.1 并发优化

- 线程池隔离 : 不同类型任务使用独立线程池
- 异步处理 : 消息发送/接收异步化
- 连接池 : 复用 FIX 连接

### 9.2 内存优化

- 对象池 : 复用 FIX 消息对象
- 流式处理 : 大文件场景配置使用流式解析
- 缓存 : 模板和配置缓存

### 9.3 监控指标

```

public class PerformanceMetrics {
    private final MeterRegistry 
    registry;

//  关键指标
    private Counter messagesSent;
    private Counter 
    messagesReceived;
    private Timer 
    scenarioExecutionTime;
    private Gauge activeConnections;
}





```

## 10. 部署与运维

### 10.1 部署架构

```

┌─────────────────┐    
┌─────────────────┐    
┌─────────────────┐
│   Test Runner   │    │  Test 
Simulator │    │   Report Server │
│   (Jenkins)     │────│   
(Docker)      │────│   
(Allure)      │
└─────────────────┘    
└─────────────────┘    
└─────────────────┘

```

### 10.2 容器化配置

```

FROM openjdk:11-jre-slim
COPY target/quickfix-test-tool.jar 
app.jar
COPY config/ /app/config/
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "/app.
jar"]

```

### 10.3 运维监控

- 健康检查 : HTTP 端点监控
- 日志聚合 : ELK Stack
- 告警机制 : Prometheus + AlertManager

## 11. 测试策略

### 11.1 单元测试

- 覆盖率目标: >80%
- 测试框架: JUnit 5 + Mockito
- 重点测试: 验证逻辑、状态转换

### 11.2 集成测试

- 端到端场景测试
- 并发测试
- 性能基准测试

### 11.3 回归测试

- 自动化测试套件
- 每晚定时执行
- 失败自动通知

## 12. 演进路线图

### Phase 1: 基础框架 (2 周)

- 项目骨架搭建
- 核心接口定义
- 基础模拟器实现

### Phase 2: 核心功能 (4 周)

- 场景配置解析
- 消息验证器
- 基础报告生成

### Phase 3: 高级功能 (3 周)

- 并发执行
- 复杂场景支持
- 性能优化

### Phase 4: 完善集成 (2 周)

- CI/CD 集成
- 监控告警
- 文档完善
